<!DOCTYPE html>
<html lang="en">

<%- include('header') %>

<style>
    .patient-table-wrapper {
        margin-top: 20px;
    }
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .selected-count {
        margin-left: 10px;
        font-weight: bold;
        color: #007bff;
    }
    .no-email-row {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .email-mode-toggle {
        margin-bottom: 15px;
    }
    #email-body-text {
        min-height: 200px;
    }
    #email-body-html {
        min-height: 300px;
    }
    .patient-checkbox:disabled {
        cursor: not-allowed;
    }
</style>

<body id="kt_body" class="header-fixed header-mobile-fixed subheader-enabled subheader-fixed aside-enabled aside-fixed aside-minimize-hoverable page-loading">
    <%- include('mobile-navbar') %>
    <div class="d-flex flex-column flex-root">
        <div class="d-flex flex-row flex-column-fluid page">
            <%- include('sidebar') %>
            <div class="d-flex flex-column flex-row-fluid wrapper pt-20" id="kt_wrapper">
                <%- include('navbar') %>
                <div class="content d-flex flex-column flex-column-fluid p-10">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header card-header-icon card-header-primary">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h4 class="card-title">Send Email to Patients</h4>
                                        </div>
                                        <div class="col-md-6 text-right">
                                            <button type="button" class="btn btn-light-primary" id="send-email-btn" disabled>
                                                <i class="fa fa-envelope"></i> Send Email
                                                <span class="selected-count" id="selected-count">(0 selected)</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Filter Section -->
                                    <div class="filter-section">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Search by Name</label>
                                                    <input type="text" class="form-control" id="filter-name" placeholder="Name">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Search by Email</label>
                                                    <input type="text" class="form-control" id="filter-email" placeholder="Email">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Search by Phone</label>
                                                    <input type="text" class="form-control" id="filter-phone" placeholder="Phone">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Filter by Status</label>
                                                    <select class="form-control" id="filter-status">
                                                        <option value="">All</option>
                                                        <option value="1">Active</option>
                                                        <option value="0">Inactive</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 text-right">
                                                <button type="button" class="btn btn-light-secondary" id="clear-filters">Clear Filters</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Patient Table -->
                                    <div class="patient-table-wrapper">
                                        <div class="table-responsive">
                                            <table class="table table-hover" id="patient_email_tb">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 40px;">
                                                            <input type="checkbox" id="select-all" />
                                                        </th>
                                                        <th>Name</th>
                                                        <th>DOB</th>
                                                        <th>Phone</th>
                                                        <th>Email</th>
                                                        <th>Full Address</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<!-- Email Message Modal -->
<div class="modal fade" id="email_message_modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Compose Email</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="email-form">
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" class="form-control" id="email-subject" required placeholder="Email Subject">
                    </div>
                    
                    <div class="form-group email-mode-toggle">
                        <label>Email Mode</label>
                        <div class="btn-group btn-group-toggle" data-toggle="buttons">
                            <label class="btn btn-outline-primary active">
                                <input type="radio" name="email-mode" value="text" checked> Text Mode
                            </label>
                            <label class="btn btn-outline-primary">
                                <input type="radio" name="email-mode" value="html"> HTML Mode
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="text-mode-container">
                        <label>Email Body (Text)</label>
                        <textarea class="form-control" id="email-body-text" rows="10" placeholder="Enter your email message here..."></textarea>
                    </div>

                    <div class="form-group" id="html-mode-container" style="display: none;">
                        <label>Email Body (HTML)</label>
                        <div id="email-body-html" class="email-summernote"></div>
                    </div>

                    <div class="form-group">
                        <small class="text-muted">
                            <i class="fa fa-info-circle"></i> 
                            <span id="recipient-info">0</span> patient(s) will receive this email
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light-primary" id="send-email-submit">
                    <i class="fa fa-paper-plane"></i> Send Email
                </button>
                <button type="button" class="btn btn-light-danger" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedPatients = [];
    let patientTable;
    let emailMode = 'text';
    let filterDebounceTimer = null;

    // Debounce function
    function debounce(func, wait) {
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(filterDebounceTimer);
                func(...args);
            };
            clearTimeout(filterDebounceTimer);
            filterDebounceTimer = setTimeout(later, wait);
        };
    }

    $(document).ready(function() {
        // Initialize Summernote for HTML mode
        $('#email-body-html').summernote({
            height: 300,
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'italic', 'underline', 'clear']],
                ['fontname', ['fontname']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture', 'video']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ]
        });

        // Initialize DataTable
        patientTable = $('#patient_email_tb').DataTable({
            "pagingType": "full_numbers",
            "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            "pageLength": 25,
            "responsive": true,
            "serverSide": false,
            "processing": true,
            "ajax": {
                "url": "<%= site_url + prefix %>/email/gp",
                "type": "POST",
                "data": function(d) {
                    d.name = $('#filter-name').val();
                    d.email = $('#filter-email').val();
                    d.phone = $('#filter-phone').val();
                    d.status = $('#filter-status').val();
                },
                "dataSrc": function(json) {
                    // Ensure we return an array
                    if (Array.isArray(json)) {
                        return json;
                    } else if (json && Array.isArray(json.data)) {
                        return json.data;
                    } else if (json && json.status === 'error') {
                        mynotify('danger', json.message || 'Error loading patients');
                        return [];
                    }
                    return [];
                },
                "error": function(xhr, error, thrown) {
                    console.error("DataTables error:", error, thrown);
                    mynotify('danger', 'Error loading patient data');
                }
            },
            "columns": [
                {
                    "data": null,
                    "orderable": false,
                    "render": function(data, type, row) {
                        const hasEmail = row.email && row.email.trim() !== '';
                        const checked = selectedPatients.includes(row.id) ? 'checked' : '';
                        const disabled = hasEmail ? '' : 'disabled';
                        return `<input type="checkbox" class="patient-checkbox" data-id="${row.id}" data-email="${row.email || ''}" ${checked} ${disabled} />`;
                    }
                },
                {
                    "data": "fname",
                    "render": function(data, type, row) {
                        const fullName = (row.fname || '') + ' ' + (row.mname || '') + ' ' + (row.lname || '');
                        return fullName.trim() || 'N/A';
                    }
                },
                {
                    "data": "dob",
                    "render": function(data, type, row) {
                        if (row.dob && new Date(row.dob) > new Date(1900, 1, 1)) {
                            return new Date(row.dob).toLocaleDateString();
                        }
                        return 'N/A';
                    }
                },
                {
                    "data": "phone",
                    "render": function(data, type, row) {
                        return row.phone || row.mobile || 'N/A';
                    }
                },
                {
                    "data": "email",
                    "render": function(data, type, row) {
                        if (row.email && row.email.trim() !== '') {
                            return `<a href="mailto:${row.email}">${row.email}</a>`;
                        }
                        return '<span class="text-danger">No Email</span>';
                    }
                },
                {
                    "data": "address",
                    "render": function(data, type, row) {
                        const address = [];
                        if (row.address) address.push(row.address);
                        if (row.city) address.push(row.city);
                        if (row.state) address.push(row.state);
                        if (row.zip) address.push(row.zip);
                        return address.join(', ') || 'N/A';
                    }
                }
            ],
            "createdRow": function(row, data, dataIndex) {
                if (!data.email || data.email.trim() === '') {
                    $(row).addClass('no-email-row');
                }
            }
        });

        // Select All checkbox
        $('#select-all').on('change', function() {
            const isChecked = $(this).prop('checked');
            $('.patient-checkbox:not(:disabled)').prop('checked', isChecked).trigger('change');
        });

        // Individual checkbox change
        $(document).on('change', '.patient-checkbox', function() {
            const patientId = parseInt($(this).data('id'));
            const patientEmail = $(this).data('email');
            const isChecked = $(this).prop('checked');

            if (isChecked && patientEmail && patientEmail.trim() !== '') {
                if (!selectedPatients.includes(patientId)) {
                    selectedPatients.push(patientId);
                }
            } else {
                selectedPatients = selectedPatients.filter(id => id !== patientId);
            }

            updateSelectedCount();
            updateSendButton();
        });

        // Debounced filter function
        const debouncedFilter = debounce(function() {
            patientTable.ajax.reload();
        }, 500); // 500ms delay

        // Filter events with debounce for text inputs
        $('#filter-name, #filter-email, #filter-phone').on('keyup input', function() {
            debouncedFilter();
        });

        // Status filter - immediate (no debounce for dropdown)
        $('#filter-status').on('change', function() {
            patientTable.ajax.reload();
        });

        // Clear filters
        $('#clear-filters').on('click', function() {
            $('#filter-name, #filter-email, #filter-phone').val('');
            $('#filter-status').val('');
            patientTable.ajax.reload();
        });

        // Send Email button
        $('#send-email-btn').on('click', function() {
            if (selectedPatients.length === 0) {
                mynotify('danger', 'Please select at least one patient with email address');
                return;
            }
            $('#recipient-info').text(selectedPatients.length);
            $('#email_message_modal').modal('show');
        });

        // Email mode toggle
        $('input[name="email-mode"]').on('change', function() {
            emailMode = $(this).val();
            if (emailMode === 'html') {
                $('#text-mode-container').hide();
                $('#html-mode-container').show();
            } else {
                $('#html-mode-container').hide();
                $('#text-mode-container').show();
            }
        });

        // Send email submit
        $('#send-email-submit').on('click', function() {
            const subject = $('#email-subject').val().trim();
            if (!subject) {
                mynotify('danger', 'Please enter email subject');
                return;
            }

            let body = '';
            if (emailMode === 'html') {
                body = $('#email-body-html').summernote('code');
                if (!body || body.trim() === '' || body === '<p><br></p>') {
                    mynotify('danger', 'Please enter email body');
                    return;
                }
            } else {
                body = $('#email-body-text').val().trim();
                if (!body) {
                    mynotify('danger', 'Please enter email body');
                    return;
                }
            }

            // Get selected patient emails
            const selectedEmails = [];
            $('.patient-checkbox:checked').each(function() {
                const email = $(this).data('email');
                if (email && email.trim() !== '') {
                    selectedEmails.push(email);
                }
            });

            if (selectedEmails.length === 0) {
                mynotify('danger', 'No valid email addresses selected');
                return;
            }

            // Send AJAX request
            $.ajax({
                url: '<%= site_url + prefix %>/email/send',
                type: 'POST',
                data: {
                    emails: selectedEmails.join(','),
                    subject: subject,
                    body: body,
                    mode: emailMode
                },
                dataType: 'json',
                success: function(response) {
                    if (response.status === 'success') {
                        mynotify('success', `Email sent successfully to ${response.successful || selectedEmails.length} patient(s)`);
                        $('#email_message_modal').modal('hide');
                        // Reset form
                        $('#email-form')[0].reset();
                        $('#email-body-html').summernote('code', '');
                        // Clear selections
                        selectedPatients = [];
                        $('.patient-checkbox').prop('checked', false);
                        $('#select-all').prop('checked', false);
                        updateSelectedCount();
                        updateSendButton();
                    } else {
                        mynotify('danger', response.message || 'Failed to send email');
                    }
                },
                error: function(xhr) {
                    mynotify('danger', 'Error sending email. Please try again.');
                    console.error(xhr);
                }
            });
        });

        function updateSelectedCount() {
            const count = selectedPatients.length;
            $('#selected-count').text(`(${count} selected)`);
        }

        function updateSendButton() {
            $('#send-email-btn').prop('disabled', selectedPatients.length === 0);
        }
    });
</script>

</html>

